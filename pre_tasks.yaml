---
- name: get play directory
  set_fact:
    play_path: '{{ hostvars["localhost"]["code"]["local_path"] }}'

- name: fetch files from remote
  fetch:
    src: '{{ play_path }}/{{ item }}'
    dest: '/tmp/'
    flat: yes
    fail_on_missing: yes
  loop:
    - 'config.yaml'
    - 'components/execute_ansible_playbook.yaml.j2'
    - 'components/set_up_ec2/docker/cron/Dockerfile.j2'

- name: load variables from config file
  include_vars:
    file: '/tmp/config.yaml'

- name: upload to remote
  template:
    src: '/tmp/{{ item.file }}.j2'
    dest: '{{ play_path }}/{{ item.path }}/{{ item.file }}'
    force: yes
  loop:
    - { file: 'execute_ansible_playbook.yaml', path: 'components' }
    - { file: 'Dockerfile', path: 'components/set_up_ec2/docker/cron' }